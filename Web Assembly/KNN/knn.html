<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Streaming</title>
    <script src="knn.js"></script>
  </head>
  <body>
    <p>Hello, Web Assembly!</p>

    <script>
      const runQueriesSimultaneously = () => {
        const numPoints = 100000;
        const dimensions = 3;
        const numQueries = 100000;
        const k = 10;

        let start = performance.now();
        const pointsPtr = Module._createFloatArray(numPoints * dimensions);
        const queriesPtr = Module._createFloatArray(numQueries * dimensions);
        console.log(
          "Time to allocate memory: " + (performance.now() - start) + "ms"
        );
        const resPtr = Module._createIntArray(numQueries * k);

        start = performance.now();
        const points = new Float32Array(
          Module.HEAPF32.buffer,
          pointsPtr,
          numPoints * dimensions
        );

        const queries = new Float32Array(
          Module.HEAPF32.buffer,
          queriesPtr,
          numQueries * dimensions
        );

        const res = new Int32Array(
          Module.HEAP32.buffer,
          resPtr,
          numQueries * k
        );

        for (let i = 0; i < numPoints * dimensions; i++) {
          points[i] = Math.random() * 1000;
        }

        for (let i = 0; i < numQueries * dimensions; i++) {
          queries[i] = Math.random() * 1000;
        }

        console.log(
          "JS: Time to generate: " + (performance.now() - start) + "ms"
        );

        start = performance.now();
        Module._run(
          pointsPtr,
          queriesPtr,
          resPtr,
          numPoints,
          numQueries,
          k,
          dimensions
        );
        console.log(
          "JS: Time to run queries: " + (performance.now() - start) + "ms"
        );
      };
    </script>

    <input type="number" id="a" />
    <button onclick="runQueriesSimultaneously()">Trigger</button>
    <p id="ret"></p>
  </body>
</html>
